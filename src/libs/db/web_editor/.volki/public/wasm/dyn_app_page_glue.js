"use strict"; const __encoder = new TextEncoder(); const __decoder = new TextDecoder(); let __handles = new Map(); let __next_handle = 1; function __new_handle(el) { const id = __next_handle++; __handles.set(id, el); return id; } let __wasm = null; function __pass_string(s) { const bytes = __encoder.encode(s); const ptr = __wasm.exports.__volki_alloc(bytes.length); if (ptr === 0) throw new Error('volki: WASM alloc failed'); new Uint8Array(__wasm.exports.memory.buffer, ptr, bytes.length).set(bytes); return [ptr, bytes.length]; } function __read_string(ptr, len) { return __decoder.decode(new Uint8Array(__wasm.exports.memory.buffer, ptr, len)); } const __components = new Map(); let __current_component = null; let __rerender_scheduled = false; let __rerender_queue = new Set(); function __register_component(id, name, renderFn) { __components.set(id, { name, slots: [], renderFn, mounted: false }); } function __schedule_rerender(comp_id) { __rerender_queue.add(comp_id); if (!__rerender_scheduled) { __rerender_scheduled = true; queueMicrotask(() => { __rerender_scheduled = false; const queue = [...__rerender_queue]; __rerender_queue.clear(); for (const id of queue) { const comp = __components.get(id); if (comp) { __wasm.exports.__volki_dealloc(); __wasm.exports[comp.renderFn](); __run_effects(id); } } }); } } function __run_effects(comp_id) { const comp = __components.get(comp_id); if (!comp || !comp.effects) return; for (let i = 0; i < comp.effects.length; i++) { const eff = comp.effects[i]; if (!eff) continue; const depsChanged = !eff.prevDeps || eff.deps.some((d, j) => d !== eff.prevDeps[j]); if (depsChanged) { const cleanupFn = `__effect_cleanup_${comp.name}_${i}`; if (typeof __wasm.exports[cleanupFn] === 'function') { __wasm.exports.__volki_dealloc(); __wasm.exports[cleanupFn](); } const effectFn = `__effect_${comp.name}_${i}`; if (typeof __wasm.exports[effectFn] === 'function') { __wasm.exports.__volki_dealloc(); __wasm.exports[effectFn](); } eff.prevDeps = [...eff.deps]; } } } const __volki_imports = { env: { __volki_component_begin(id) { __current_component = id; }, __volki_component_end() { const comp = __components.get(__current_component); if (comp) comp.mounted = true; __current_component = null; }, __volki_state_init_i32(slot, initial) { const comp = __components.get(__current_component); if (!comp) return initial; if (!comp.mounted) { comp.slots[slot] = initial; } return comp.slots[slot]; }, __volki_xstate_get_i32(comp_id, slot) { const comp = __components.get(comp_id); return comp ? (comp.slots[slot] ?? 0) : 0; }, __volki_xstate_set_i32(comp_id, slot, value) { const comp = __components.get(comp_id); if (!comp) return; comp.slots[slot] = value; __schedule_rerender(comp_id); }, __volki_xstate_get_f32(comp_id, slot) { const comp = __components.get(comp_id); return comp ? (comp.slots[slot] ?? 0.0) : 0.0; }, __volki_xstate_set_f32(comp_id, slot, value) { const comp = __components.get(comp_id); if (!comp) return; comp.slots[slot] = value; __schedule_rerender(comp_id); }, __volki_state_fmt_i32(value, buf_ptr, buf_len) { const s = String(value); const bytes = __encoder.encode(s); const len = Math.min(bytes.length, buf_len); new Uint8Array(__wasm.exports.memory.buffer, buf_ptr, len).set(bytes.subarray(0, len)); return len; }, __volki_dom_query(sel_ptr, sel_len) { const sel = __read_string(sel_ptr, sel_len); const el = document.querySelector(sel); return el ? __new_handle(el) : 0; }, __volki_dom_set_text(handle, text_ptr, text_len) { const el = __handles.get(handle); if (el) el.textContent = __read_string(text_ptr, text_len); }, __volki_dom_get_value(handle) { const el = __handles.get(handle); if (!el) return 0; const val = el.value || ''; const [ptr, _] = __pass_string(val); return ptr; }, __volki_dom_get_value_len(handle) { const el = __handles.get(handle); if (!el) return 0; return __encoder.encode(el.value || '').length; }, __volki_dom_add_class(handle, cls_ptr, cls_len) { const el = __handles.get(handle); if (el) el.classList.add(__read_string(cls_ptr, cls_len)); }, __volki_dom_remove_class(handle, cls_ptr, cls_len) { const el = __handles.get(handle); if (el) el.classList.remove(__read_string(cls_ptr, cls_len)); }, __volki_console_log(msg_ptr, msg_len) { console.log(__read_string(msg_ptr, msg_len)); }, __volki_console_log_i32(value) { console.log(value); }, } }; const __volki_handlers = Object.create(null); function __coerce_event_arg(event, paramType) { const target = event && event.target ? event.target : null; if (paramType === "bool") { return target && ("checked" in target) ? !!target.checked : false; } if (paramType === "number") { if (!target || !("value" in target)) return 0; const n = Number(target.value); return Number.isFinite(n) ? n : 0; } if (paramType === "string") { return target && ("value" in target) ? String(target.value ?? "") : ""; } return event; } function __bind_volki_handlers() { const all = document.querySelectorAll("*"); for (const el of all) { for (const attr of el.getAttributeNames()) { if (!attr.startsWith("data-volki-on")) continue; const eventName = attr.slice("data-volki-on".length); if (!eventName) continue; const handlerName = el.getAttribute(attr); const handler = handlerName ? __volki_handlers[handlerName] : null; if (!handler) { console.error(`volki: missing client handler '${handlerName}' for ${attr}`); continue; } if (handler.arity > 1) { console.error(`volki: handler '${handlerName}' has unsupported arity ${handler.arity}`); continue; } el.addEventListener(eventName, (event) => { if (eventName === "click" && el.tagName === "A") { event.preventDefault(); } try { if (handler.arity === 0) { handler.call(); return; } const kind = handler.paramTypes[0] || "event"; handler.call(__coerce_event_arg(event, kind)); } catch (e) { console.error(`volki: handler '${handlerName}' failed for event '${eventName}'`, e); } }); } } } async function __volki_init() { const response = await fetch("/wasm/dyn_app_page_client.wasm"); const bytes = await response.arrayBuffer(); const result = await WebAssembly.instantiate(bytes, __volki_imports); __wasm = result.instance; __register_component(0, "delete_dialog", "__volki_component_delete_dialog"); __register_component(1, "status_display", "__volki_component_status_display"); __register_component(2, "insert_button", "__volki_component_insert_button"); __register_component(3, "counter", "__volki_component_counter"); __wasm.exports.__volki_dealloc(); __wasm.exports.__volki_component_delete_dialog(); __run_effects(0); __wasm.exports.__volki_component_status_display(); __run_effects(1); __wasm.exports.__volki_component_insert_button(); __run_effects(2); __wasm.exports.__volki_component_counter(); __run_effects(3); __bind_volki_handlers(); } __volki_handlers["filter_rows"] = { arity: 0, paramTypes: [], call: function() { __wasm.exports.__volki_dealloc(); __wasm.exports.filter_rows(); } }; __volki_handlers["toggle_select_all"] = { arity: 1, paramTypes: ["bool"], call: function(checked) { __wasm.exports.__volki_dealloc(); __wasm.exports.toggle_select_all((checked ? 1 : 0)); } }; __volki_handlers["delete_selected"] = { arity: 0, paramTypes: [], call: function() { __wasm.exports.__volki_dealloc(); __wasm.exports.delete_selected(); } }; __volki_handlers["cancel_delete"] = { arity: 0, paramTypes: [], call: function() { __wasm.exports.__volki_dealloc(); __wasm.exports.cancel_delete(); } }; __volki_handlers["confirm_delete"] = { arity: 0, paramTypes: [], call: function() { __wasm.exports.__volki_dealloc(); __wasm.exports.confirm_delete(); } }; __volki_handlers["insert_row"] = { arity: 0, paramTypes: [], call: function() { __wasm.exports.__volki_dealloc(); __wasm.exports.insert_row(); } }; __volki_handlers["on_increment"] = { arity: 0, paramTypes: [], call: function() { __wasm.exports.__volki_dealloc(); __wasm.exports.on_increment(); } }; __volki_handlers["on_decrement"] = { arity: 0, paramTypes: [], call: function() { __wasm.exports.__volki_dealloc(); __wasm.exports.on_decrement(); } }; __volki_init().catch(e => console.error('volki WASM init failed:', e));